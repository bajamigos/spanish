<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Antonimo Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Antonimo Admin Dashboard</h1>

  <div class="admin-dashboard">
    <div class="admin-card">
      <h2>Upload / Replace CSV</h2>
      <input type="file" id="csvUpload" accept=".csv">
      <div class="destination-options" style="display: flex; flex-direction: column;">
        <label><input type="checkbox" name="destination" value="Flashcard-data.csv"> Flashcard-data.csv</label>
        <label><input type="checkbox" name="destination" value="wordladder.csv"> wordladder.csv</label>
        <label><input type="checkbox" name="destination" value="wordhunt.csv"> wordhunt.csv</label>
        <label><input type="checkbox" name="destination" value="placeholder.csv"> placeholder.csv</label>
        <label><input type="checkbox" name="destination" value="monologue-ideas.csv"> monologue-ideas.csv</label>
        <label><input type="checkbox" name="destination" value="Debate-topics.csv"> Debate-topics.csv</label>
        <label><input type="checkbox" name="destination" value="Rollplay-ideas.csv"> Rollplay-ideas.csv</label>
        <label><input type="checkbox" name="destination" value="Podcast-ideas.csv"> Podcast-ideas.csv</label>
      </div>
      <button id="csvUploadBtn">Upload CSV</button>
      <table class="csv-preview-table" id="csvPreview"></table>
    </div>

    <div class="admin-card">
      <h2>User Management</h2>
      <input type="text" id="userSearch" placeholder="Enter user email">
      <button id="resetUserBtn">Reset User Progress</button>
      <div id="userActionMsg"></div>
    </div>

    <div class="admin-card">
      <h2>Stats Overview</h2>
      <div class="admin-stats">
        <div class="stat-box" id="totalUsers">Users: --</div>
        <div class="stat-box" id="activeUsers">Active (7d): --</div>
        <div class="stat-box" id="totalReviews">Reviews: --</div>
        <div class="stat-box" id="avgEF">Avg EF: --</div>
        <div class="stat-box" id="cardsAdded">Cards This Week: --</div>
      </div>
    </div>

    <!-- New Card for Monthly Leaderboard Reset -->
    <div class="admin-card">
      <h2>Monthly Leaderboard Reset</h2>
      <p>Reset the top contributors leaderboard and flashcard contribution counters for the new month. This action is irreversible and should be performed at the end of each month.</p>
      <button id="resetLeaderboardBtn">Reset Leaderboard</button>
      <div id="leaderboardActionMsg" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
    </div>
  </div>

  <img src="antonimo-logo.jpg" alt="Antonimo logo" class="logo-bg">

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDJYgI-xgZAGj6780W8BqXS4thd8ODvfDA",
    authDomain: "antonimo-acbd9.firebaseapp.com",
    projectId: "antonimo-acbd9",
    storageBucket: "antonimo-acbd9.firebasestorage.app",
    messagingSenderId: "904238822187",
    appId: "1:904238822187:web:2c0488369954495f3b8b6e",
    measurementId: "G-GTP9X49KNP"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Existing CSV Preview Functionality
  document.getElementById('csvUploadBtn').onclick = async () => {
    const file = document.getElementById('csvUpload').files[0];
    if (!file) return alert('Select a CSV first!');
    const text = await file.text();
    const [header, ...rows] = text.split('\n').filter(Boolean);
    const headers = header.split(',');
    const table = document.getElementById('csvPreview');
    table.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>' +
      rows.slice(0, 5).map(r => `<tr>${r.split(',').map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
  };

  // Enhanced Stats Loading with Improved Anonymous Authentication and Error Handling
  async function loadStats() {
    try {
      console.log('Initiating stats load...');
      
      // Ensure anonymous sign-in for admin access
      if (!firebase.auth().currentUser) {
        console.log('No current user; attempting anonymous sign-in...');
        await firebase.auth().signInAnonymously();
        // Brief delay to ensure auth state propagates
        await new Promise(resolve => setTimeout(resolve, 1000));
        console.log('Anonymous sign-in completed.');
      } else {
        console.log('User already authenticated.');
      }

      console.log('Querying Firestore users collection...');
      const usersSnap = await db.collection('users').get();
      document.getElementById('totalUsers').textContent = `Users: ${usersSnap.size}`;
      console.log(`Stats loaded: ${usersSnap.size} users.`);
    } catch (error) {
      console.error('Stats loading error:', error);
      document.getElementById('totalUsers').textContent = 'Users: N/A (Permissions or network issue)';
    }
  }
  loadStats();

  // New Leaderboard Reset Functionality with Enhanced Error Logging
  const resetEndpoint = 'https://siele-elf-6477d7a8fbd0.herokuapp.com/reset-leaderboard';
  const leaderboardActionMsg = document.getElementById('leaderboardActionMsg');

  document.getElementById('resetLeaderboardBtn').onclick = async () => {
    if (!confirm('Are you sure? This will clear all monthly contribution data and reset counters for top contributors and flashcards. Proceed only at month-end.')) {
      return;
    }

    try {
      console.log('Reset button clicked; initiating fetch...');
      leaderboardActionMsg.textContent = 'Resetting leaderboard...';
      leaderboardActionMsg.style.color = '#007bff'; // Blue for processing

      const response = await fetch(resetEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ timestamp: new Date().toISOString(), action: 'monthly_reset' })
      });

      console.log('Fetch response status:', response.status);
      if (response.ok) {
        const data = await response.json();
        console.log('Reset successful:', data);
        leaderboardActionMsg.textContent = 'Leaderboard reset successfully. Counters initialized for the new month.';
        leaderboardActionMsg.style.color = '#28a745'; // Green for success
      } else {
        const errorText = await response.text();
        console.error('Non-OK response:', response.status, errorText);
        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
      }
    } catch (error) {
      console.error('Full reset error:', error);
      leaderboardActionMsg.textContent = `Reset failed: ${error.message}. Please check console and backend.`;
      leaderboardActionMsg.style.color = '#dc3545'; // Red for error
    }
  };
  </script>
</body>
</html>
