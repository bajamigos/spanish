<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Antonimo Flashcards</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            position: relative;
            min-height: 100vh;
            background-color: white;
            overflow-x: hidden;
        }
        .logo-bg {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 600px;
            opacity: 0.25;
            z-index: -1;
            pointer-events: none;
        }
        @media (max-width: 800px) {
            .logo-bg {
                width: 80vw;
                opacity: 0.3;
            }
        }
        #flashcard {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        #front {
            font-size: 1.2em;
        }
        .hint { font-size: 1em; color: #666; }
        .above-hint { margin-bottom: 20px; }
        .below-hint { margin-top: 20px; }
        #card-num { font-size: 0.8em; color: #999; }
        button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
        }
        #buttons {
            display: flex;
            justify-content: center;
        }
        #srs-status {
            margin-top: 10px;
            font-style: italic;
            color: blue;
        }
        #result {
            margin: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Flashcards v.2025.10.25</h1>
    <p id="learned">Learned cards: 0</p>
    <div id="flashcard">
        <div id="card-num"></div>
        <div id="front"></div>
        <div id="srs-status"></div>
    </div>
    <div id="buttons">
        <button id="flipBtn" onclick="flip()">Show Answer</button>
        <div id="rate" style="display:none;">
            <button onclick="rate(false)">Incorrect</button>
            <button onclick="rate(true)">Correct</button>
        </div>
    </div>
    <p id="result"></p>
    <img src="antonimo-logo.jpg" alt="Antonimo logo" class="logo-bg">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOCAbC123dEf456GhI789jKl012-MnO",
            authDomain: "myapp-project-123.firebaseapp.com",
            projectId: "myapp-project-123",
            storageBucket: "myapp-bucket.appspot.com",
            messagingSenderId: "65211879809",
            appId: "1:65211879909:web:3ae38ef1cdcb2e01fe5f0c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let uid;
        let scales = {};
        let cards = [];
        let srsData = [];
        let currentId;
        let flipped = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                uid = user.uid;
                loadProgress();
            } else {
                signInAnonymously(auth)
                    .then(() => console.log('Signed in anonymously'))
                    .catch((error) => console.error('Anonymous auth failed:', error));
            }
        });

        async function loadProgress() {
            const progressRef = doc(db, 'users', uid, 'srs', 'progress');
            const progressSnap = await getDoc(progressRef);
            if (progressSnap.exists()) {
                srsData = progressSnap.data().progress;
            } else {
                srsData = Array(cards.length).fill().map(() => ({streak: 0, ef: 2.5, interval: 0, dueDate: 0, learnedTime: 0}));
            }
            updateLearned();
            newGame();
        }

        async function saveProgress() {
            const progressRef = doc(db, 'users', uid, 'srs', 'progress');
            await setDoc(progressRef, { progress: srsData });
        }

        async function loadData() {
            const response = await fetch('flashcard-data.csv');
            const csvText = await response.text();
            const lines = csvText.trim().split('\n').slice(1);
            const data = lines.map(line => {
                const [pair, pos, hint, gradtype, orderStr, word, sentencesStr] = line.split(',');
                const order = parseInt(orderStr);
                const sentences = sentencesStr ? sentencesStr.split('|') : [];
                return {pair, pos, hint, gradtype, order, word, sentences};
            });
            data.forEach(d => {
                if (!scales[d.pair]) scales[d.pair] = [];
                scales[d.pair].push({order: d.order, word: d.word});
                d.sentences.forEach(sent => {
                    cards.push({front: sent, back: d.word, pair: d.pair, order: d.order});
                });
            });
            for (let p in scales) {
                scales[p].sort((a, b) => a.order - b.order);
                scales[p] = scales[p].map(w => w.word);
            }
            if (uid) loadProgress();
        }

        function updateLearned() {
            const now = Date.now();
            const day = 24 * 60 * 60 * 1000;
            const count = srsData.filter((d, i) => d.learnedTime > now - day).length;
            document.getElementById('learned').textContent = `Learned cards: ${count}/${cards.length}`;
        }

        function showCard() {
            if (!cards[currentId]) return;
            const card = cards[currentId];
            const this_scale = scales[card.pair];
            const index = card.order;
            const lower = index > 0 ? this_scale[index - 1] : '';
            const higher = index < this_scale.length - 1 ? this_scale[index + 1] : '';
            let frontHtml = '';
            if (higher) frontHtml += `<div class="hint above-hint">${higher}</div>`;
            let sentence = card.front;
            if (flipped) {
                sentence = sentence.replace('_____', `<strong style="color: green;">${card.back}</strong>`);
            }
            frontHtml += sentence;
            if (lower) frontHtml += `<div class="hint below-hint">${lower}</div>`;
            document.getElementById('front').innerHTML = frontHtml;
            document.getElementById('card-num').textContent = `Card ${currentId + 1}`;
            document.getElementById('flipBtn').style.display = flipped ? 'none' : 'block';
            document.getElementById('rate').style.display = flipped ? 'block' : 'none';

            const status = document.getElementById('srs-status');
            const item = srsData[currentId];
            if (item.streak === 0) {
                status.textContent = 'New card';
            } else if (item.dueDate <= Date.now()) {
                status.textContent = 'DUE NOW';
            } else {
                const minutes = Math.ceil((item.dueDate - Date.now()) / 60000);
                status.textContent = `Next review in ${minutes} minutes`;
            }
        }

        function flip() {
            flipped = true;
            showCard();
        }

        function updateSRS(index, isCorrect) {
            let item = srsData[index];
            let quality = isCorrect ? 5 : 0;
            if (quality < 3) {
                item.streak = 0;
            } else {
                item.streak++;
            }
            item.ef = item.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (item.ef < 1.3) item.ef = 1.3;
            let reps = item.streak;
            let interval;
            if (reps <= 1) {
                interval = 1;
            } else if (reps === 2) {
                interval = 6;
            } else {
                interval = Math.round(item.interval * item.ef);
            }
            item.interval = interval;
            item.dueDate = Date.now() + interval * 60000;
            if (item.streak === 3 && item.learnedTime === 0) {
                item.learnedTime = Date.now();
            }
        }

        function getDueItemIndex() {
            const now = Date.now();
            let newCards = [];
            let overdue = [];
            let future = [];
            for (let i = 0; i < cards.length; i++) {
                const item = srsData[i];
                if (item.streak === 0) {
                    newCards.push(i);
                } else if (item.dueDate <= now) {
                    overdue.push({index: i, overdueTime: now - item.dueDate});
                } else {
                    future.push({index: i, dueDate: item.dueDate});
                }
            }
            if (newCards.length > 0) {
                return newCards[Math.floor(Math.random() * newCards.length)];
            } else if (overdue.length > 0) {
                overdue.sort((a, b) => b.overdueTime - a.overdueTime);
                return overdue[0].index;
            } else if (future.length > 0) {
                future.sort((a, b) => a.dueDate - b.dueDate);
                return future[0].index;
            } else {
                return -1;
            }
        }

        function rate(isCorrect) {
            updateSRS(currentId, isCorrect);
            saveProgress();
            updateLearned();
            flipped = false;
            const nextId = getDueItemIndex();
            if (nextId === -1) {
                document.getElementById('flashcard').style.display = 'none';
                document.getElementById('buttons').style.display = 'none';
                document.getElementById('result').textContent = 'All cards up to date! Come back later.';
            } else {
                currentId = nextId;
                showCard();
            }
        }

        function newGame() {
            const nextId = getDueItemIndex();
            if (nextId === -1) {
                document.getElementById('flashcard').style.display = 'none';
                document.getElementById('buttons').style.display = 'none';
                document.getElementById('result').textContent = 'All cards up to date! Come back later.';
            } else {
                document.getElementById('flashcard').style.display = 'block';
                document.getElementById('buttons').style.display = 'flex';
                currentId = nextId;
                showCard();
            }
        }

        loadData();
    </script>
</body>
</html>
