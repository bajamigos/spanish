<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tarea 5 SIELE S4: Debate de Opinión</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="wordhunt.css" />
  <style>
    .hidden {
      display: none !important;
      visibility: hidden;
      opacity: 0;
    }

    #debate-ai-section {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="header-placeholder">Loading header...</div>

  <div class="content-card">
    <p>
      Para la Tarea 5 del SIELE S4, el estudiante debate opiniones en español,
      practicando expresión oral.
    </p>

    <div id="tab-debate">
      <p>
        Genera un tema de debate aleatorio y asigna roles para practicar
        argumentos.
      </p>
      <select id="category-select">
        <option value="">Todas las categorías</option>
      </select>
      <button id="generate-button">Generar Tema</button>
      <p id="debate-category"></p>
      <p id="debate-prompt"></p>
      <button id="assign-roles">Asignar Roles</button>
      <div id="role-output"></div>

      <div class="contribute-section">
        <div class="action-panel">
          <button
            class="tally-button"
            data-tally-open="debateFormID"
            data-tally-hide-title="1"
            data-tally-layout="modal"
            data-tally-auto-close="1000"
          >
            Sugerir Nuevo Tema
          </button>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button class="new-image-button" id="toggle-wordhunt-scoreboard">
        Mostrar Marcador
      </button>

      <!-- Debate button + external SVG wrapper -->
      <div class="debate-ai-wrapper">
        <button class="new-image-button" id="toggle-debate-ai">
          Debate Pelagos Ai
        </button>
        <div class="debate-ai-icon" id="refresh-debate-ai" title="Actualizar debate">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <defs>
              <radialGradient id="geminiGradient" cx="50%" cy="50%" r="75%">
                <stop offset="0%" stop-color="#9b72cb"/>
                <stop offset="100%" stop-color="#4285f4"/>
              </radialGradient>
            </defs>
            <path fill="url(#geminiGradient)"
              d="M256 32C141 32 48 125 48 240s93 208 208 208 208-93 208-208S371 32 256 32zm79 114c31 0 58 27 58 58 0 29-23 58-59 61 36 4 59 32 59 61 0 31-27 58-58 58-33 0-60-26-79-56-19 30-46 56-79 56-31 0-58-27-58-58 0-29 23-58 59-61-36-4-59-32-59-61 0-31 27-58 58-58 33 0 60 26 79 56 19-30 46-56 79-56z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Word Hunt Scoreboard -->
    <section id="wordhunt-scoreboard" class="hidden">
      <div class="word-display" id="wordhunt-word-box">
        Haz clic en "Iniciar"
      </div>

      <div class="score">
        <div>Tiempo: <span id="wordhunt-timer">120</span>s</div>
        <div>Acertadas: <span id="wordhunt-caught">0</span></div>
        <div>Falladas: <span id="wordhunt-missed">0</span></div>
      </div>

      <div class="controls">
        <button id="wordhunt-toggle-game">Iniciar</button>
        <button id="wordhunt-toggle-translation">Mostrar Traducción</button>
        <label for="wordhunt-speed-control">Velocidad:</label>
        <input
          type="number"
          id="wordhunt-speed-control"
          min="1"
          max="10"
          value="5"
        />
        <button id="wordhunt-reset-game">Reiniciar</button>
      </div>

      <div class="controls" style="margin-top: 1rem">
        <button
          class="tally-button"
          data-tally-open="3xkzJy"
          data-tally-hide-title="1"
          data-tally-emoji-animation="none"
        >
          Añadir conectores discursivos
        </button>
      </div>
    </section>

    <!-- Debate AI Section -->
    <section id="debate-ai-section" class="hidden">
      <div class="argument-box">
        <h3>Opening Argument</h3>
        <textarea id="opening-argument" rows="8" readonly></textarea>
      </div>
      <div class="argument-box">
        <h3>Cross Examination</h3>
        <textarea id="cross-examination" rows="8" readonly></textarea>
      </div>
      <div class="argument-box">
        <h3>Closing Arguments</h3>
        <textarea id="closing-arguments" rows="8" readonly></textarea>
      </div>
    </section>
  </div>

  <div id="footer-placeholder">Loading footer...</div>

  <script async src="https://tally.so/widgets/embed.js"></script>
  <script src="common.js"></script>
  <script src="wordhunt.js"></script>

  <script>
    const taskName = "Tarea 5 SIELE S4";

    // Parse CSV safely (handles commas inside quotes)
    function parseCsvRow(line) {
      const row = [];
      let cur = "", inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') { cur += '"'; i++; }
            else inQuotes = false;
          } else cur += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ",") { row.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      row.push(cur);
      return row;
    }

    let debateData = [];
    let currentItem = null;
    let tutorSide = null;

    async function loadDebateTopics() {
      try {
        const response = await fetch("debatetopics.csv");
        const csvText = await response.text();
        const lines = csvText.replace(/\r/g, "").split("\n").filter(l => l.trim());
        lines.shift();
        debateData = lines.map(line => {
          const c = parseCsvRow(line);
          return {
            category: c[0],
            prompt: c[1],
            Apertura_Pro: c[2],
            Apertura_Contra: c[3],
            Contra_Examen_Pro: c[4],
            Contra_Examen_Contra: c[5],
            Cierre_Pro: c[6],
            Cierre_Contra: c[7],
          };
        });
        const cats = [...new Set(debateData.map(i => i.category))];
        const sel = document.getElementById("category-select");
        cats.forEach(cat => {
          const o = document.createElement("option");
          o.value = cat;
          o.textContent = cat;
          sel.appendChild(o);
        });
      } catch (err) {
        console.error("Error loading CSV:", err);
      }
    }

    function populateDebateBoxes() {
      const open = document.getElementById("opening-argument");
      const cross = document.getElementById("cross-examination");
      const close = document.getElementById("closing-arguments");
      if (currentItem && tutorSide) {
        open.value = tutorSide === "Pro" ? currentItem.Apertura_Pro : currentItem.Apertura_Contra;
        cross.value = tutorSide === "Pro" ? currentItem.Contra_Examen_Pro : currentItem.Contra_Examen_Contra;
        close.value = tutorSide === "Pro" ? currentItem.Cierre_Pro : currentItem.Cierre_Contra;
      } else {
        open.value = "Genera un tema y asigna roles primero.";
        cross.value = "Genera un tema y asigna roles primero.";
        close.value = "Genera un tema y asigna roles primero.";
      }
    }

    function generatePrompt() {
      const cat = document.getElementById("category-select").value;
      const pool = cat ? debateData.filter(i => i.category === cat) : debateData;
      if (!pool.length) return;
      currentItem = pool[Math.floor(Math.random() * pool.length)];
      document.getElementById("debate-category").textContent = currentItem.category;
      document.getElementById("debate-prompt").textContent = currentItem.prompt;
      document.getElementById("role-output").innerHTML = "";
      tutorSide = null;
    }

    window.addEventListener("load", () => {
      loadIncludes();
      window.addEventListener("resize", handleResponsive);
      loadDebateTopics();

      const toggleBtn = document.getElementById("toggle-debate-ai");
      const refreshIcon = document.getElementById("refresh-debate-ai");
      const debateSection = document.getElementById("debate-ai-section");

      debateSection.classList.add("hidden");

      toggleBtn.addEventListener("click", () => {
        const hidden = debateSection.classList.toggle("hidden");
        toggleBtn.textContent = hidden ? "Debate Pelagos Ai" : "Ocultar Debate Ai";
        if (!hidden) populateDebateBoxes();
      });

      refreshIcon.addEventListener("click", () => {
        populateDebateBoxes();
        refreshIcon.style.transform = "rotate(360deg)";
        setTimeout(() => (refreshIcon.style.transform = ""), 400);
      });

      document.getElementById("generate-button").addEventListener("click", generatePrompt);
      document.getElementById("assign-roles").addEventListener("click", () => {
        if (!currentItem) {
          alert("Genera un tema primero para asignar roles.");
          return;
        }
        const roles = ["Pro", "Contra"];
        const tIndex = Math.floor(Math.random() * 2);
        tutorSide = roles[tIndex];
        const student = roles[1 - tIndex];
        document.getElementById("role-output").innerHTML = `<p>Tutor: ${tutorSide}</p><p>Estudiante: ${student}</p>`;
      });
    });
  </script>
</body>
</html>
