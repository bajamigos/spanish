<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tarea 2 SIELE S4: Responder a Medios</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="wordhunt.css" />
  <style>
    .carousel-wrapper {
      position: relative;
      margin-top: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 10px;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      scroll-behavior: smooth;
      max-width: 100%;
    }
    .carousel::-webkit-scrollbar {
      display: none;
    }
    .carousel-item {
      flex: 0 0 auto;
      width: 200px;
      scroll-snap-align: start;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border-radius: 8px;
      background: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .carousel-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }
    .carousel-item img {
      width: 100%;
      height: auto;
      border-radius: 8px 8px 0 0;
    }
    .carousel-item p {
      font-size: 0.85rem;
      margin: 5px;
      color: #333;
    }
    .carousel-btn {
      display: none;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      color: #333;
      cursor: pointer;
      transition: background 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      z-index: 5;
    }
    .carousel-btn:hover {
      background: rgba(240, 240, 240, 0.9);
    }
    .carousel-btn.left {
      left: -10px;
    }
    .carousel-btn.right {
      right: -10px;
    }
    @media (min-width: 768px) {
      .carousel-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="header-placeholder">Loading header...</div>
  <div class="content-card">
    <p>
      Para la Tarea 2 del SIELE S4, el estudiante responde a videos en español,
      practicando expresión oral.
    </p>
    <div id="video-container" class="image-container">
      <iframe
        id="video-iframe"
        width="560"
        height="315"
        src=""
        frameborder="0"
        allowfullscreen
      ></iframe>
    </div>
    <p id="channel-info">Cargando video...</p>
    <button class="new-image-button" onclick="loadNextVideo()">
      Siguiente Video
    </button>
    <h3 style="margin-top: 1.5rem">Más videos sugeridos</h3>
    <div class="carousel-wrapper">
      <button class="carousel-btn left" id="scroll-left">‹</button>
      <div id="suggested-videos" class="carousel"></div>
      <button class="carousel-btn right" id="scroll-right">›</button>
    </div>
    <div class="button-group">
      <button class="new-image-button" id="toggle-wordhunt-scoreboard">
        Mostrar Marcador
      </button>
    </div>
    <section id="wordhunt-scoreboard" class="hidden">
      <div class="word-display" id="wordhunt-word-box">
        Haz clic en "Iniciar"
      </div>
      <div class="score">
        <div>Tiempo: <span id="wordhunt-timer">120</span>s</div>
        <div>Acertadas: <span id="wordhunt-caught">0</span></div>
        <div>Falladas: <span id="wordhunt-missed">0</span></div>
      </div>
      <div class="controls">
        <button id="wordhunt-toggle-game">Iniciar</button>
        <button id="wordhunt-toggle-translation">Mostrar Traducción</button>
        <label for="wordhunt-speed-control">Velocidad:</label>
        <input
          type="number"
          id="wordhunt-speed-control"
          min="1"
          max="10"
          value="5"
        />
        <button id="wordhunt-reset-game">Reiniciar</button>
      </div>
      <div class="controls" style="margin-top: 1rem">
        <button
          class="tally-button"
          data-tally-open="3xkzJy"
          data-tally-hide-title="1"
          data-tally-emoji-animation="none"
        >
          Añadir conectores discursivos
        </button>
      </div>
    </section>
  </div>
  <div id="footer-placeholder">Loading footer...</div>
  <script async src="https://tally.so/widgets/embed.js"></script>
  <script src="common.js"></script>
  <script src="wordhunt.js"></script>
  <script>
    const taskName = 'Tarea 2 SIELE S4';
    const channels = [
      { name: "DW Español", id: "UCT4Jg8h03dD0iN3Pb5L0PMA" },
      { name: "BBC Mundo", id: "UCv8CkQ9wZHQMwlUZtIoyUAA" },
      { name: "France 24 Español", id: "UCUdOoVWuWmgo1wByzcsyKDQ" },
      { name: "RT en Español", id: "UCEIhICHOQOonjE6V0SLdrHQ" },
      { name: "El País", id: "UCnsvJeZO4RigQ898WdDhkFQ" },
      { name: "CNN en Español", id: "UC_lEiu6917IJz03TnntWUaQ" },
      { name: "Univision Noticias", id: "UC32TdiIsh_5X8tKr_9rKQyA" },
      { name: "Telemundo Noticias", id: "UCRwA1NUcUnwsly35ikGhp0A" },
      { name: "Voz de América", id: "UCXQSHGZP6StIywcGofGdm0Q" },
      { name: "Al Jazeera Español", id: "UC6DcwP4bW65JrY1y2y5Vayw" },
      { name: "QuantumFracture", id: "UCV7UOhZ2XuPZcV0CjH0XGpA" },
      { name: "Date un Vlog", id: "UCt8y1xdHoRj1sZ4fHfN8O8w" },
      { name: "CuriosaMente", id: "UCX0LJHhMYJtUcbm1sR5IToA" },
      { name: "C de Ciencia", id: "UCzR-rom72PHN9Zg7RML9EbA" },
      { name: "Dot CSV", id: "UCy5znSnfMsDwaLlROnZ7Qbg" },
      { name: "National Geographic en Español", id: "UCQ1t91xvQYJYIHUQ3r-LH3w" },
      { name: "Aprendemos Juntos BBVA", id: "UCzpXoZQWXU0cG9c7SgRZrUg" },
      { name: "La Capital", id: "UCZDxJPcxo5eK6aYybx4Lz-A" },
      { name: "Ter", id: "UCz6mp8cDK0nZvjYbSmF8Rxg" }
    ];
    let allVideos = [];
    let currentVideoIndex = -1;
    let isLoading = false;

    async function fetchAllVideos() {
      if (isLoading) return;
      isLoading = true;
      allVideos = [];
      const fetchPromises = channels.map(async ch => {
        const feedUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${ch.id}`;
        try {
          const res = await fetch(feedUrl);
          if (!res.ok) throw new Error(res.statusText);
          const xmlText = await res.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          const entries = [...xmlDoc.getElementsByTagName("entry")].slice(0, 10);
          const videos = entries.map(e => ({
            id: e.getElementsByTagName("yt:videoId")[0].textContent,
            title: e.getElementsByTagName("title")[0].textContent,
            channel: ch.name,
            published: new Date(e.getElementsByTagName("published")[0].textContent)
          }));
          await new Promise(resolve => setTimeout(resolve, 500)); // Delay to avoid rate limits
          return videos;
        } catch (err) {
          console.warn(`Error fetching ${ch.name}:`, err.message);
          return [];
        }
      });
      const results = await Promise.all(fetchPromises);
      allVideos = results.flat();
      allVideos.sort((a, b) => b.published - a.published); // Sort by newest first
      if (allVideos.length === 0) {
        document.getElementById("channel-info").textContent =
          "No se encontraron videos. Intenta más tarde.";
        isLoading = false;
        return;
      }
      // Shuffle after sorting
      for (let i = allVideos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allVideos[i], allVideos[j]] = [allVideos[j], allVideos[i]];
      }
      loadVideo(allVideos[0]);
      isLoading = false;
    }

    function loadVideo(video) {
      document.getElementById("video-iframe").src =
        `https://www.youtube.com/embed/${video.id}?autoplay=0`;
      document.getElementById("channel-info").textContent = video.channel;
      showCarousel();
    }

    function loadNextVideo() {
      if (allVideos.length === 0) {
        document.getElementById("channel-info").textContent = "Cargando videos...";
        fetchAllVideos();
        return;
      }
      currentVideoIndex = (currentVideoIndex + 1) % allVideos.length;
      loadVideo(allVideos[currentVideoIndex]);
    }

    function showCarousel() {
      const carousel = document.getElementById("suggested-videos");
      carousel.innerHTML = ""; // Clear previous
      const suggested = allVideos.slice(currentVideoIndex + 1, currentVideoIndex + 11); // Next 10 videos
      suggested.forEach(video => {
        const item = document.createElement("div");
        item.classList.add("carousel-item");
        item.innerHTML = `
          <img src="https://img.youtube.com/vi/${video.id}/mqdefault.jpg" alt="${video.title}" />
          <p>${video.title.substring(0, 50)}...</p>
        `;
        item.addEventListener("click", () => loadVideo(video));
        carousel.appendChild(item);
      });
    }

    // Carousel arrow navigation
    document.getElementById("scroll-left").addEventListener("click", () => {
      const carousel = document.getElementById("suggested-videos");
      carousel.scrollBy({ left: -220, behavior: "smooth" });
    });

    document.getElementById("scroll-right").addEventListener("click", () => {
      const carousel = document.getElementById("suggested-videos");
      carousel.scrollBy({ left: 220, behavior: "smooth" });
    });

    window.addEventListener('load', () => {
      loadIncludes();
      fetchAllVideos();
      window.addEventListener('resize', handleResponsive);
    });
  </script>
</body>
</html>
