<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarea 2 SIELE S4: Responder a Medios</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="header-placeholder">Loading header...</div>
    
    <div class="content-card">
        <p>Para la Tarea 2 del SIELE S4, el estudiante responde a videos en español, practicando expresión oral.</p>
        <div id="video-container" class="image-container">
            <iframe id="video-iframe" width="560" height="315" src="" frameborder="0" allowfullscreen></iframe>
        </div>
        <p id="channel-info">Cargando video...</p>
        <button class="new-image-button" onclick="loadNextVideo()">Siguiente Video</button>
    </div>
    
    <div id="footer-placeholder">Loading footer...</div>

    <script src="common.js"></script>
    <script>
        const taskName = 'Tarea 2 SIELE S4';

        const channels = [
            { name: 'DW Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCT4Jg8h03dD0iN3Pb5L0PMA' },
            { name: 'BBC Mundo', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCv8CkQ9wZHQMwlUZtIoyUAA' },
            { name: 'France 24 Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCUdOoVWuWmgo1wByzcsyKDQ' },
            { name: 'RT en Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCEIhICHOQOonjE6V0SLdrHQ' },
            { name: 'El País', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCnsvJeZO4RigQ898WdDhkFQ' },
            { name: 'CNN en Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC_lEiu6917IJz03TnntWUaQ' },
            { name: 'Univision Noticias', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC32TdiIsh_5X8tKr_9rKQyA' },
            { name: 'Telemundo Noticias', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCRwA1NUcUnwsly35ikGhp0A' },
            { name: 'Voz de América', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCXQSHGZP6StIywcGofGdm0Q' },
            { name: 'Al Jazeera Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC6DcwP4bW65JrY1y2y5Vayw' }
        ];

        let allVideos = [];
        let currentVideoIndex = -1;
        let isLoading = false;
        
        async function fetchAllVideos() {
            if (isLoading) return;
            isLoading = true;
            allVideos = [];
            
            for (const channel of channels) {
                console.log('Trying to open the door for ' + channel.name + '...');
                try {
                    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(channel.rss)}&count=10`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.status === 'ok' && data.items) {
                        data.items.forEach(item => {
                            const match = item.link.match(/v=([^&]+)/);
                            if (match) {
                                allVideos.push({
                                    id: match[1],
                                    channel: channel.name,
                                    title: item.title,
                                    published: new Date(item.pubDate)
                                });
                            }
                        });
                        console.log('Yay, got videos from ' + channel.name + '! Added ' + data.items.length + ' videos.');
                    } else {
                        console.log('No good stuff inside for ' + channel.name + '. Status: ' + data.status);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('Oops, error for ' + channel.name + ': ' + error.message);
                }
            }
            
            allVideos.sort((a, b) => b.published - a.published);
            
            for (let i = allVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allVideos[i], allVideos[j]] = [allVideos[j], allVideos[i]];
            }
            
            isLoading = false;
            
            console.log('All done! Total videos found: ' + allVideos.length);
            
            if (allVideos.length > 0) {
                loadVideo(allVideos[0]);
            } else {
                document.getElementById('channel-info').textContent = 'No videos found—check the notes in console for which doors are grumpy!';
            }
        }
        
        function loadVideo(video) {
            document.getElementById('video-iframe').src = `https://www.youtube.com/embed/${video.id}?autoplay=0`;
            document.getElementById('channel-info').textContent = `${video.channel}`;
        }
        
        function loadNextVideo() {
            if (allVideos.length === 0) {
                document.getElementById('channel-info').textContent = 'Cargando videos...';
                fetchAllVideos();
                return;
            }
            
            currentVideoIndex = (currentVideoIndex + 1) % allVideos.length;
            loadVideo(allVideos[currentVideoIndex]);
            
            if (currentVideoIndex === 0) {
                fetchAllVideos();
            }
        }

        window.addEventListener('load', () => {
            loadIncludes();
            fetchAllVideos();
            window.addEventListener('resize', handleResponsive);
        });
    </script>
</body>
</html>                console.log('Header and footer are ready!');
                
                // Now that footer's here, make buttons listen, fix clock, fill bars, and check phone size!
                attachEventListeners();
                updateTimerDisplay();
                updateProgress();
                setInterval(updateProgress, 30000); // Check elf friend every 30 seconds.
                handleResponsive();
            } catch (error) {
                console.error('Problem loading:', error);
                // Backup toy if lost.
                headerPlaceholder.innerHTML = '<div class="header-card"><a href="index.html" class="home-button">[HOME]</a><h1>SIELE S4 Study Guide</h1></div>';
                footerPlaceholder.innerHTML = '<div class="footer-card"><p>Backup footer—find the real one!</p></div>';
            }
            // After loading, get the videos ready with notes to see what's happening.
            fetchAllVideos();
        }

        // Step for videos: List of Spanish YouTube channels (all in Spanish, with good doors!).
        const channels = [
            { name: 'DW Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCT4Jg8h03dD0iN3Pb5L0PMA' },
            { name: 'BBC Mundo', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCv8CkQ9wZHQMwlUZtIoyUAA' },
            { name: 'France 24 Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCUdOoVWuWmgo1wByzcsyKDQ' },
            { name: 'RT en Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCEIhICHOQOonjE6V0SLdrHQ' },
            { name: 'El País', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCnsvJeZO4RigQ898WdDhkFQ' },
            { name: 'CNN en Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC_lEiu6917IJz03TnntWUaQ' },
            { name: 'Univision Noticias', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC32TdiIsh_5X8tKr_9rKQyA' },
            { name: 'Telemundo Noticias', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCRwA1NUcUnwsly35ikGhp0A' },
            { name: 'Voz de América', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCXQSHGZP6StIywcGofGdm0Q' },
            { name: 'Al Jazeera Español', rss: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC6DcwP4bW65JrY1y2y5Vayw' }
        ];

        let allVideos = [];
        let currentVideoIndex = -1;
        let isLoading = false;
        
        async function fetchAllVideos() {
            if (isLoading) return;
            isLoading = true;
            allVideos = [];
            
            for (const channel of channels) {
                console.log('Trying to open the door for ' + channel.name + '...'); // Note to see which one we're trying.
                try {
                    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(channel.rss)}&count=10`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.status === 'ok' && data.items) {
                        data.items.forEach(item => {
                            const match = item.link.match(/v=([^&]+)/);
                            if (match) {
                                allVideos.push({
                                    id: match[1],
                                    channel: channel.name,
                                    title: item.title,
                                    published: new Date(item.pubDate)
                                });
                            }
                        });
                        console.log('Yay, got videos from ' + channel.name + '! Added ' + data.items.length + ' videos.'); // Note if good.
                    } else {
                        console.log('No good stuff inside for ' + channel.name + '. Status: ' + data.status); // Note if no data.
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500)); // Longer rest to give time, like waiting for your turn on the swing.
                } catch (error) {
                    console.error('Oops, error for ' + channel.name + ': ' + error.message); // Note the problem.
                }
            }
            
            allVideos.sort((a, b) => b.published - a.published); // Newest first.
            
            for (let i = allVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allVideos[i], allVideos[j]] = [allVideos[j], allVideos[i]]; // Mix random.
            }
            
            isLoading = false;
            
            console.log('All done! Total videos found: ' + allVideos.length); // Final note.
            
            if (allVideos.length > 0) {
                loadVideo(allVideos[0]);
            } else {
                document.getElementById('channel-info').textContent = 'No videos found—check the notes in console for which doors are grumpy!';
            }
        }
        
        function loadVideo(video) {
            document.getElementById('video-iframe').src = `https://www.youtube.com/embed/${video.id}?autoplay=0`;
            document.getElementById('channel-info').textContent = `${video.channel}`;
        }
        
        function loadNextVideo() {
            if (allVideos.length === 0) {
                document.getElementById('channel-info').textContent = 'Cargando videos...';
                fetchAllVideos();
                return;
            }
            
            currentVideoIndex = (currentVideoIndex + 1) % allVideos.length;
            loadVideo(allVideos[currentVideoIndex]);
            
            if (currentVideoIndex === 0) {
                fetchAllVideos();
            }
        }

        // Step for timer and recorder fun.
        let timerInterval, seconds = 120, isRunning = false; // 2 minutes for video response.
        let mediaRecorder, audioChunks = [];
        const webhookUrl = 'https://hooks.zapier.com/hooks/catch/25050495/urdpdfu/'; // Your magic key!
        const taskName = 'Tarea 2 SIELE S4';
        
        function updateTimerDisplay() {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            if (seconds <= 0) stopTimer();
        }
        
        function startTimer() {
            if (!isRunning && seconds > 0) {
                timerInterval = setInterval(() => {
                    seconds--;
                    updateTimerDisplay();
                    if (seconds <= 0) stopTimer();
                }, 1000);
                isRunning = true;
            }
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            isRunning = false;
        }
        
        function resetTimer() {
            stopTimer();
            seconds = 120;
            updateTimerDisplay();
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];
                    sendToZapier(audioBlob);
                };
                mediaRecorder.start();
                startTimer(); // Timer starts with recording.
                console.log('Recording—say something fun!');
            } catch (error) {
                alert('Mic trouble: ' + error.message);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                stopTimer();
            }
        }
        
        async function sendToZapier(audioBlob) {
            const formData = new FormData();
            const timestamp = new Date().toISOString();
            formData.append('file', audioBlob, 'recording.webm');
            formData.append('timestamp', timestamp);
            formData.append('task', taskName);
            try {
                const response = await fetch(webhookUrl, { method: 'POST', body: formData });
                if (response.ok) {
                    alert('Sent to your Drive—good job!');
                } else {
                    throw new Error('Send failed');
                }
            } catch (error) {
                alert('Error: ' + error.message + '. Check wifi!');
            }
        }
        
        function attachEventListeners() {
            document.getElementById('start-timer-btn').addEventListener('click', startTimer);
            document.getElementById('start-record-btn').addEventListener('click', startRecording);
            document.getElementById('stop-btn').addEventListener('click', () => {
                stopTimer();
                stopRecording();
            });
            document.getElementById('reset-btn').addEventListener('click', resetTimer);
        }

        // Step for getting numbers from your elf friend.
        async function updateProgress() {
            try {
                const response = await fetch('https://siele-elf-6477d7a8fbd0.herokuapp.com/progress');
                if (!response.ok) throw new Error('Elf is napping');
                const data = await response.json();
                document.getElementById('flash-text').textContent = `${data.flash.total}/50 (${data.flash.percent}%)`;
                document.getElementById('pron-text').textContent = `${data.pron.total}/50 (${data.pron.percent}%)`;
                document.getElementById('error-text').textContent = `${data.error.total}/50 (${data.error.percent}%)`;
                document.getElementById('flash-bar').value = data.flash.total;
                document.getElementById('pron-bar').value = data.pron.total;
                document.getElementById('error-bar').value = data.error.total;
                const tutorsList = document.getElementById('top-tutors');
                tutorsList.innerHTML = data.topTutors.map((tutor, index) => `<li>${index + 1}. ${tutor}</li>`).join('');
                console.log('Numbers updated!');
            } catch (error) {
                console.error('Elf trouble:', error);
                // Backup numbers if elf is gone.
                document.getElementById('flash-text').textContent = '28/50 (56%)';
                document.getElementById('pron-text').textContent = '35/50 (70%)';
                document.getElementById('error-text').textContent = '42/50 (84%)';
                document.getElementById('flash-bar').value = 28;
                document.getElementById('pron-bar').value = 35;
                document.getElementById('error-bar').value = 42;
                document.getElementById('top-tutors').innerHTML = '<li>1. Maria - 45</li><li>2. Alex - 38</li><li>3. Sofia - 32</li>';
            }
        }

        // Step for phone or big screen—make bars fit.
        function handleResponsive() {
            const isMobile = window.innerWidth < 768;
            const progressSection = document.querySelector('.progress-section');
            if (progressSection) {
                progressSection.style.flexDirection = isMobile ? 'column' : 'row';
            }
        }

        // Start our game when the page opens!
        window.addEventListener('load', () => {
            loadIncludes(); // This starts loading and fixing everything inside.
        });
    </script>
</body>
</html>
